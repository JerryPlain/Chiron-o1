# 辅助脚本导读（`run.py` / `mics.py` 之外）

目标：帮你快速回答“除了 `run.py` 和 `mics.py`，其他脚本在系统里分别做什么、何时会被调用、何时只是独立工具”。

## 1. 先看总图：谁在主链路里，谁是旁路工具

```text
主链路（一次 MICS 搜索任务）
run.py
└── mics.py
    ├── model.py                 # 加载本地 intern 模型
    ├── utils.py                 # I/O、API forward、选择策略、文本处理
    ├── step.py                  # 推理树节点结构
    ├── prompt.py                # 生成/评估/裁判 prompt 模板
    ├── qwenvl_forward.py        # 本地 Qwen-VL 推理封装
    └── internvl_forward.py      # 本地 InternVL 推理封装

旁路工具（不直接参与 run.py 主循环）
infer.py                         # 单模型推理示例脚本
eval/eval.py                     # 离线评测脚本
train/*.sh + train/*.json        # 训练入口与 Deepspeed 配置
```

一句话：
- `src/` 里的大部分模块是 **MICS 在线搜索时的运行依赖**。
- `infer.py` / `eval/eval.py` / `train/*` 是 **独立任务脚本**（演示、评测、训练）。

## 2. 主链路辅助模块（会被 `run.py` / `mics.py` 直接调用）

### 2.1 `src/model.py`

职责：本地 intern 模型加载与设备映射。

关键点：
- `init_model(args)` 加载 `qwen25_vl_7b`、`qwen2_vl_7b`、`internvl3_8b`。
- `split_model(model_path)` 为 InternVL 生成多卡 `device_map`。
- 输出 `model_set`，供 `mics.py` 的 `_call_model_forward` 取用。

你什么时候看它：
- 模型加载报错
- 想替换/新增 intern 模型
- 想调整多卡映射策略

### 2.2 `src/utils.py`

职责：通用工具层（I/O、远程 API 调用、策略函数、文本清洗）。

主要包含：
- 数据与图片：`read_jsonl`、`get_chunk`、`locate_img`、`encode_image`
- API forward：`gpt_forward`、`qwenplus_forward`、`ds_forward`
- 评分/选择：`get_correctness`、`select_best_mentor`、`select_next_step`
- 文本处理：`replace_image_references`、`extract_first_step`、`extract_first_two_steps`

你什么时候看它：
- 图片路径找不到
- 分数/选择逻辑看起来不合理
- 想改 tie-break 策略

### 2.3 `src/step.py`

职责：推理树节点数据结构。

核心字段：
- `parent` / `children`
- `step_text` / `prefix_steps` / `text`（完整链）
- `score` / `generated_by` / `depth`

核心方法：
- `add_child_step`
- `get_full_reasoning`
- `get_step_path`

你什么时候看它：
- 不理解 `temp_step` / `current_step` 怎么组成完整上下文
- 想把 beam size 从 1 变多分支时

### 2.4 `src/prompt.py`

职责：集中管理三类模板。

- `REASONING_PROMPT`：mentor 生成推理链
- `EVALUATE_PROMPT`：intern 输出最终答案
- `JUDGE_PROMPT`：evaluator 判 Yes/No

你什么时候看它：
- 想提准确率或稳定性
- 发现模型经常不按 `### The final answer is:` 格式输出

### 2.5 `src/qwenvl_forward.py`

职责：本地 Qwen-VL 推理封装。

流程：
- 构造多模态 chat message
- `processor.apply_chat_template` + `process_vision_info`
- `model.generate` 后 trim 输入 token，再 decode

你什么时候看它：
- Qwen 路由分支输出异常
- 多图输入格式不对

### 2.6 `src/internvl_forward.py`

职责：本地 InternVL 推理封装。

流程：
- 动态切 patch（`dynamic_preprocess`）
- 图像 transform + stack
- 单图/多图两条 `model.chat` 路径

你什么时候看它：
- InternVL 推理慢/显存高
- `<image>` 与 patch 数量不匹配

## 3. 旁路独立脚本（不在 MICS 主循环里）

### 3.1 `infer.py`

用途：单模型推理示例（偏 demo）。

特点：
- 直接加载一个 Chiron 模型并 `model.chat(...)`
- 演示单图和多图推理写法
- 不走 mentor-intern 搜索流程

你什么时候用：
- 快速 smoke test 模型是否可用
- 验证纯推理输出，不关心 MICS 搜索

### 3.2 `eval/eval.py`

用途：离线评测脚本。

做的事：
- 读评测集 JSON
- 本地模型推理得到答案
- 用 DeepSeek 判对错（闭集准确率）
- 用 BERTScore 计算语义分（开放题）
- 写 `output.json` 与最终指标

你什么时候用：
- 比较模型版本
- 跑 benchmark 报告

### 3.3 `train/*.sh` + `train/zero_stage1_config.json`

用途：训练入口模板（基于 InternVL 训练体系）。

包含：
- `internvl2_5_2b_dynamic_res_2nd_finetune_lora.sh`
- `internvl2_5_8b_dynamic_res_2nd_finetune_lora.sh`
- `zero_stage1_config.json`（Deepspeed ZeRO stage 1 配置）

你什么时候用：
- 做 LoRA 微调
- 调训练 batch、GPU 数、deepspeed 参数

## 4. 常见误区（你现在最该避免）

1. 把 `infer.py` 当成 MICS 主流程
- 不是，它只是单模型推理样例。

2. 把 `eval/eval.py` 当成训练脚本
- 不是，它是离线评测。

3. 以为 `prompt.py` 只影响 mentor
- 不是，intern 与 evaluator 都受 prompt 模板约束。

4. 只改 `mics.py` 不看 `utils.py`
- 评分、选择、图片处理很多关键逻辑在 `utils.py`。

## 5. 推荐阅读顺序（在你已看懂 run/mics 的前提下）

1. `src/step.py`（先看结构）
2. `src/utils.py`（再看策略和 I/O）
3. `src/prompt.py`（看行为约束）
4. `src/model.py`（看模型加载）
5. `src/qwenvl_forward.py` + `src/internvl_forward.py`（看本地 forward 细节）
6. `infer.py`（看最小推理示例）
7. `eval/eval.py`（看评测口径）
8. `train/*`（最后看训练）

## 6. 你可以用这 3 个问题自测

1. 哪些文件是 `run.py -> mics.py` 任务执行时一定会触发的？
2. 哪些文件不会被主流程调用，但用于“验证/评测/训练”？
3. 如果我要提升准确率、鲁棒性、吞吐量，分别优先改哪个文件？
